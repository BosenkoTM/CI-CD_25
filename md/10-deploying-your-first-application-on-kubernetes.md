# Урок 10: Развертывание приложения в Kubernetes

## Введение в развертывания и сервисы

В этом уроке вы узнаете, как развернуть простое приложение в Kubernetes с помощью **Развертывания** и запустить его как **Сервис**. В качестве приложения мы будем использовать базовый веб-сервер Nginx. К концу этого урока вы поймете концепции Pod, Deployments и Services в Kubernetes.

## Что такое Pod, Deployments и Services?

- **Pod**: наименьшая развертываемая единица в Kubernetes. Pod может содержать один или несколько контейнеров, которые совместно используют одно и то же сетевое пространство имен и хранилище. Pod являются эфемерными и могут быть созданы, уничтожены или реплицированы на основе желаемого состояния, определенного пользователем.

- **Deployment**: абстракция более высокого уровня, которая управляет набором идентичных Pod. Он обеспечивает запуск нужного количества Pod и может беспрепятственно обрабатывать обновления приложения.

- **Сервис**: абстракция, которая определяет логический набор Pod и политику доступа к ним. Сервисы обеспечивают связь между различными частями вашего приложения и предоставляют стабильные конечные точки для доступа к Pod.

## Шаг 1: Создание простого развертывания

1. **Откройте свой терминал**: Убедитесь, что вы подключены к кластеру Kubernetes.

2. **Создайте развертывание**: Используйте следующую команду для создания развертывания, которое запускает веб-сервер Nginx:

```bash
kubectl create deployment nginx-deployment --image=nginx
```

Эта команда создает развертывание с именем `nginx-deployment`, используя официальный образ Nginx.

3. **Проверьте развертывание**: чтобы проверить состояние развертывания и увидеть созданные им модули, выполните:

```bash
kubectl get deployments
```

Вы должны увидеть вывод, указывающий на то, что `nginx-deployment` запущен.

4. **Список модулей**: чтобы увидеть созданные развертыванием модули, используйте:

```bash
kubectl get pods
```

Вы должны увидеть один или несколько модулей с именами, начинающимися с `nginx-deployment`.

## Шаг 2: Установите развертывание как службу

Теперь, когда у вас запущено развертывание, вы можете предоставить его как службу, чтобы сделать его доступным извне кластера.

1. **Открыть развертывание**: выполните следующую команду, чтобы создать службу, которая открывает развертывание Nginx:

```bash
kubectl expose deployment nginx-deployment --type=NodePort --port=80
```

- Параметр `--type=NodePort` открывает службу на статическом порту на каждом узле в кластере.
- Параметр `--port=80` указывает, что служба будет прослушивать порт 80.

2. **Проверка службы**: чтобы проверить состояние службы, используйте:

```bash
kubectl get services
```

Вы должны увидеть службу с именем `nginx-deployment` с назначенным `NodePort`.

3. **Получить NodePort**: чтобы узнать, какой порт был назначен, найдите столбец `PORT(S)` в выводе предыдущей команды. Он будет выглядеть примерно так: `80:<NodePort>/TCP`.

## Шаг 3: Доступ к приложению Nginx

1. **Получить IP-адрес узла**: Для доступа к приложению Nginx вам понадобится IP-адрес одного из узлов в вашем кластере. Если вы используете Minikube, вы можете получить IP-адрес, запустив:

```bash
minikube ip
```

Если вы используете Docker Desktop, вы можете получить доступ к приложению, используя `localhost`.

2. **Получить доступ к приложению**: Откройте веб-браузер и перейдите по адресу `http://<Node-IP>:<NodePort>`. Замените `<Node-IP>` на полученный вами IP-адрес, а `<NodePort>` на номер порта из службы.

Вы должны увидеть страницу приветствия Nginx, указывающую на то, что ваше приложение успешно запущено.

## Шаг 4: Очистка ресурсов

После тестирования приложения вы можете очистить созданные вами ресурсы.

1. **Удалите службу**:

```bash
kubectl delete service nginx-deployment
```

2. **Удалите развертывание**:

```bash
kubectl delete deployment nginx-deployment
```

3. **Проверка удаления**: Чтобы убедиться, что ресурсы удалены, вы можете запустить:

```bash
kubectl get deployments
kubectl get services
```

Вы не должны увидеть никаких ресурсов, перечисленных для `nginx-deployment`.

## Заключение

В этом уроке вы узнали, как развернуть простое приложение в Kubernetes с помощью развертывания и предоставить его в качестве службы. Вы изучили концепции Pods, Deployments и Services, получив практический опыт работы с Kubernetes. На следующем уроке мы углубимся в масштабирование приложений и управление обновлениями в Kubernetes.

## Лабораторная работа 4. Развертывание приложения в Kubernetes

### Цель работы: освоить процесс развертывания приложения в Kubernetes с использованием Deployments и Services.

###Задачи:
1. Создать Deployment для указанного приложения.
2. Создать Service для обеспечения доступа к приложению.
3. Проверить доступность приложения через созданный Service.
4. Выполнить индивидуальное задание.

###Критерии оценки:
- Правильность создания Deployment (9 балла).
- Корректность создания Service (9 балла).
- Доступность приложения через Service (6 балла).
- Выполнение индивидуального задания (6 балла).

###Ход работы (пример для Варианта 25).

1. Создание Deployment для приложения чата на Node.js и Socket.IO.
- Убедитесь, что вы подключены к кластеру Kubernetes.
- Создайте файл `deployment.yaml` со следующим содержимым:
  ```yaml
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: nodejs-chat-app
  spec:
    replicas: 3
    selector:
      matchLabels:
        app: nodejs-chat-app
    template:
      meta
        labels:
          app: nodejs-chat-app
      spec:
        containers:
        - name: nodejs-chat-app
          image: <ваш-docker-образ>
          ports:
          - containerPort: 3000
  ```
- Замените `<ваш-docker-образ>` на имя Docker-образа вашего приложения чата.
- Примените конфигурацию Deployment:
  ```
  kubectl apply -f deployment.yaml
  ```

2. Создание Service для доступа к приложению.
- Создайте файл `service.yaml` со следующим содержимым:
  ```yaml
  apiVersion: v1
  kind: Service
  metadata:
    name: nodejs-chat-app
  spec:
    selector:
      app: nodejs-chat-app
    ports:
      - port: 80
        targetPort: 3000
    type: LoadBalancer
  ```
- Примените конфигурацию Service:
  ```
  kubectl apply -f service.yaml
  ```

3. Проверка доступности приложения.
- Получите внешний IP-адрес Service:
  ```
  kubectl get services
  ```
- Найдите Service `nodejs-chat-app` и используйте указанный внешний IP-адрес (в столбце `EXTERNAL-IP`).
- Откройте веб-браузер и перейдите по адресу `http://<внешний-ip>`. Вы должны увидеть интерфейс чата.

4. Очистка ресурсов.
- Удалите созданные ресурсы:
  ```
  kubectl delete -f service.yaml
  kubectl delete -f deployment.yaml
  ```

### Индивидуальные задания.

Вариант 1. Разверните приложение на `Flask`, использующее базу данных `PostgreSQL`, в `Kubernetes`. Создайте `Deployment` для `Flask` и `PostgreSQL`, а также `Service` для доступа к приложению.

Вариант 2. Разверните приложение на `Django`, использующее базу данных `MySQL`, в `Kubernetes`. Создайте `Deployment` для `Django` и `MySQL`, а также `Service` для доступа к приложению.

Вариант 3. Разверните приложение на `Express.js`, использующее базу данных `MongoDB`, в `Kubernetes`. Создайте `Deployment` для `Express.js` и `MongoDB`, а также `Service` для доступа к приложению.

Вариант 4. Разверните приложение на `Laravel`, использующее базу данных `PostgreSQL`, в `Kubernetes`. Создайте `Deployment` для `Laravel` и `PostgreSQL`, а также `Service` для доступа к приложению.

Вариант 5. Разверните приложение на `Ruby on Rails`, использующее базу данных `MySQL`, в `Kubernetes`. Создайте `Deployment` для `Ruby on Rails` и `MySQL`, а также `Service` для доступа к приложению.

Вариант 6. Разверните приложение на `Spring Boot`, использующее базу данных `PostgreSQL`, в `Kubernetes`. Создайте `Deployment` для `Spring Boot` и `PostgreSQL`, а также `Service` для доступа к приложению.

Вариант 7. Разверните приложение на `ASP.NET Core`, использующее базу данных `SQL Server`, в `Kubernetes`. Создайте `Deployment` для `ASP.NET Core` и `SQL Server`, а также `Service` для доступа к приложению.

Вариант 8. Разверните приложение на `Golang`, использующее базу данных `PostgreSQL`, в `Kubernetes`. Создайте `Deployment` для `Golang` и `PostgreSQL`, а также `Service` для доступа к приложению.

Вариант 9. Разверните приложение на `PHP`, использующее базу данных `MySQL` и `Apache` в качестве веб-сервера, в `Kubernetes`. Создайте `Deployment` для `PHP`, `MySQL` и `Apache`, а также `Service` для доступа к приложению.

Вариант 10. Разверните приложение на `Node.js`, использующее базу данных `MongoDB` и `Nginx` в качестве обратного прокси, в `Kubernetes`. Создайте `Deployment` для `Node.js`, `MongoDB` и `Nginx`, а также `Service` для доступа к приложению.

Вариант 11. Разверните приложение на `Flask`, использующее базу данных `SQLite` и `Gunicorn` в качестве сервера приложений, в `Kubernetes`. Создайте `Deployment` для `Flask` и `Gunicorn`, а также `Service` для доступа к приложению.

Вариант 12. Разверните приложение на `Django`, использующее базу данных `PostgreSQL` и `Nginx` для обслуживания статических файлов, в `Kubernetes`. Создайте `Deployment` для `Django`, `PostgreSQL` и `Nginx`, а также `Service` для доступа к приложению.

Вариант 13. Разверните приложение на `Express.js`, использующее базу данных `MySQL` и `Redis` для сеансов, в `Kubernetes`. Создайте `Deployment` для `Express.js`, `MySQL` и `Redis`, а также `Service` для доступа к приложению.

Вариант 14. Разверните приложение на `Laravel`, использующее базу данных `MongoDB`, в `Kubernetes`. Создайте `Deployment` для `Laravel` и `MongoDB`, а также `Service` для доступа к приложению.

Вариант 15. Разверните приложение на `Ruby on Rails`, использующее базу данных `PostgreSQL` и `Nginx` для обслуживания статических файлов, в `Kubernetes`. Создайте `Deployment` для `Ruby on Rails`, `PostgreSQL` и `Nginx`, а также `Service` для доступа к приложению.

Вариант 16. Разверните приложение на `Spring Boot`, использующее базу данных `MySQL и `Elasticsearch` для полнотекстового поиска, в `Kubernetes`. Создайте `Deployment` для `Spring Boot`, MySQL и `Elasticsearch`, а также `Service` для доступа к приложению.

Вариант 17. Разверните приложение на `ASP.NET Core`, использующее базу данных `PostgreSQL` и `Seq` для ведения журналов, в `Kubernetes`. Создайте Deployment для `ASP.NET Core`, `PostgreSQL` и `Seq`, а также `Service` для доступа к приложению.

Вариант 18. Разверните приложение на `Golang`, использующее базу данных `MongoDB` и Prometheus для мониторинга, в `Kubernetes`. Создайте `Deployment` для `Golang`, `MongoDB` и Prometheus, а также `Service` для доступа к приложению.

Вариант 19. Разверните приложение на `PHP`, использующее базу данных `PostgreSQL`, Nginx в качестве веб-сервера и `Adminer` для администрирования базы данных, в `Kubernetes`. Создайте `Deployment` для `PHP`, `PostgreSQL`, `Nginx` и `Adminer`, а также `Service` для доступа к приложению.

Вариант 20. Разверните приложение на `Node.js`, использующее базу данных `Redis` и Grafana для визуализации данных, в `Kubernetes`. Создайте `Deployment` для `Node.js`, `Redis` и `Grafana`, а также `Service` для доступа к приложению.

Вариант 21. Разверните приложение на `Flask`, использующее базу данных `MySQL и `Celery` для выполнения периодических задач, в `Kubernetes`. Создайте `Deployment` для `Flask`, `MySQL` и `Celery, а также `Service` для доступа к приложению.

Вариант 22. Разверните приложение на `Django`, использующее базу данных `SQLite` и `Django Debug Toolbar` для отладки, в `Kubernetes`. Создайте `Deployment` для `Django` и `Django Debug Toolbar`, а также `Service` для доступа к приложению.

Вариант 23. Разверните приложение на `Express.js`, использующее базу данных `PostgreSQL` и `pgAdmin` для администрирования базы данных, в `Kubernetes`. Создайте `Deployment` для `Express.js`, `PostgreSQL` и `pgAdmin`, а также `Service` для доступа к приложению.

Вариант 24. Разверните приложение на `Laravel`, использующее базу данных `MySQL` и `Laravel Echo Server` для обработки событий в реальном времени, в `Kubernetes`. Создайте `Deployment` для `Laravel`, `MySQL` и `Laravel Echo Server`, а также `Service` для доступа к приложению.

Вариант 25. Разверните приложение на `Ruby on Rails`, использующее базу данных `MongoDB` и `Sidekiq Web` для мониторинга фоновых задач, в `Kubernetes`. Создайте `Deployment` для `Ruby on Rails`, `MongoDB` и `Sidekiq Web`, а также `Service` для доступа к приложению.

### Форма отчета.
1. Титульный лист.
2. Цель работы.
3. Ход выполнения работы (с указанием используемых команд и их результатов).
4. Листинг созданных файлов конфигурации Kubernetes (Deployment и Service).
5. Выводы по работе.
6. Ответы на контрольные вопросы.

### Контрольные вопросы.
1. Что такое Pod, Deployment и Service в Kubernetes?
2. Каково назначение Deployment в Kubernetes?
3. Каково назначение Service в Kubernetes?
4. Как создать Deployment в Kubernetes?
5. Как создать Service в Kubernetes и какие типы Services существуют?

