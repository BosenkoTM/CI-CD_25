# Урок 25: Неизменяемая инфраструктура с Packer

## Введение
В современном мире быстрой разработки и развертывания приложений концепция неизменяемой инфраструктуры становится все более важной. Неизменяемая инфраструктура - это подход, при котором инфраструктура, такая как серверы и виртуальные машины, создается и настраивается автоматически, а затем никогда не изменяется после развертывания. Вместо этого, когда требуются изменения, создается новая инфраструктура с обновленной конфигурацией.

Packer - это инструмент с открытым исходным кодом, разработанный HashiCorp, который позволяет автоматизировать создание образов виртуальных машин для различных платформ, таких как Amazon Web Services (AWS), Google Cloud Platform (GCP), Microsoft Azure и др. Packer играет ключевую роль в реализации неизменяемой инфраструктуры, обеспечивая согласованность, воспроизводимость и эффективность процесса создания образов.

## Преимущества неизменяемой инфраструктуры
1. **Согласованность**: Неизменяемая инфраструктура гарантирует, что все экземпляры серверов или виртуальных машин идентичны, что устраняет проблемы, связанные с расхождениями конфигурации.

2. **Воспроизводимость**: Автоматизированный процесс создания инфраструктуры с использованием Packer обеспечивает воспроизводимость, позволяя легко создавать идентичные среды для разработки, тестирования и производства.

3. **Упрощение управления**: С неизменяемой инфраструктурой нет необходимости управлять обновлениями или изменениями конфигурации на работающих серверах. Вместо этого создаются новые экземпляры с обновленной конфигурацией, что упрощает управление и снижает риски.

4. **Быстрое развертывание**: Packer позволяет создавать предварительно настроенные образы виртуальных машин, которые могут быть быстро развернуты, сокращая время, необходимое для подготовки новых серверов или сред.

5. **Улучшенная безопасность**: Неизменяемая инфраструктура снижает риск несанкционированных изменений или конфигураций, повышая общую безопасность инфраструктуры.

## Основные концепции Packer
1. **Шаблоны**: Packer использует шаблоны в формате JSON для определения конфигурации образа виртуальной машины. Шаблоны включают в себя информацию о платформе назначения, источнике образа, настройках подготовки и постпроцессорах.

2. **Строители (Builders)**: Строители - это компоненты Packer, которые отвечают за создание образа виртуальной машины для конкретной платформы, такой как AWS, GCP или VirtualBox.

3. **Подготовители (Provisioners)**: Подготовители используются для установки программного обеспечения, настройки конфигурации и выполнения других задач настройки внутри виртуальной машины во время процесса сборки образа.

4. **Постпроцессоры (Post-processors)**: Постпроцессоры выполняются после создания образа и могут использоваться для дополнительных задач, таких как сжатие, загрузка или регистрация образа.

## Пример использования Packer
Давайте рассмотрим простой пример использования Packer для создания образа виртуальной машины Amazon EC2 с предустановленным веб-сервером Apache:

```json
{
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "us-west-2",
      "source_ami": "ami-0c55b159cbfafe1f0",
      "instance_type": "t2.micro",
      "ssh_username": "ubuntu",
      "ami_name": "packer-example-{{timestamp}}"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sudo apt-get update",
        "sudo apt-get install -y apache2"
      ]
    }
  ]
}
```

В этом примере мы определяем строителя `amazon-ebs` для создания образа виртуальной машины Amazon EC2. Мы указываем регион, исходный образ AMI, тип инстанса и имя результирующего AMI.

В разделе `provisioners` мы используем провайдер `shell` для выполнения команд внутри виртуальной машины. В данном случае мы обновляем пакеты и устанавливаем веб-сервер Apache.

После определения шаблона Packer мы можем запустить процесс сборки образа, выполнив команду `packer build template.json`. Packer автоматически создаст виртуальную машину, выполнит указанные шаги подготовки и создаст новый образ AMI с предустановленным веб-сервером Apache.

## Заключение
Неизменяемая инфраструктура и использование инструментов, таких как Packer, могут значительно улучшить процесс управления инфраструктурой, обеспечивая согласованность, воспроизводимость и эффективность. Packer упрощает создание предварительно настроенных образов виртуальных машин, которые можно быстро развернуть в различных средах.

Для специалистов в области бизнес-информатики понимание концепций неизменяемой инфраструктуры и умение использовать инструменты, такие как Packer, является ценным навыком. Это позволяет эффективно управлять инфраструктурой, поддерживающей бизнес-приложения и сервисы, обеспечивая их надежность, масштабируемость и безопасность.

В дальнейшем мы рассмотрим более сложные сценарии использования Packer, включая интеграцию с другими инструментами инфраструктуры, такими как Terraform и Ansible, для создания полностью автоматизированных конвейеров развертывания инфраструктуры.


## Лабораторная работа 5.1. Создание неизменяемой инфраструктуры с использованием Packer

### Цель работы: освоить процесс создания неизменяемой инфраструктуры с использованием инструмента Packer.

### Задачи:
1. Установить и настроить `Packer`.
2. Создать шаблон `Packer` для указанного образа виртуальной машины.
3. Собрать образ виртуальной машины с использованием `Packer`.
4. Проверить работоспособность созданного образа виртуальной машины.
5. Выполнить индивидуальное задание.

### Критерии оценки:
- Правильность установки и настройки `Packer` (4 балла).
- Корректность создания шаблона `Packer` (6 балла).
- Успешная сборка образа виртуальной машины (6 балла).
- Работоспособность созданного образа виртуальной машины (2 балл).
- Выполнение индивидуального задания (2 балл).

### Ход работы (пример для Варианта 25):

1. Установка и настройка `Packer`.
- Скачайте и установите `Packer` с официального сайта: https://www.packer.io/downloads
- Убедитесь, что `Packer` успешно установлен, выполнив команду в терминале:
  ```
  packer version
  ```

2. Создание шаблона `Packer` для образа виртуальной машины с `WordPress`.
- Создайте новую директорию для проекта и перейдите в нее:
  ```
  mkdir wordpress-packer
  cd wordpress-packer
  ```
- Создайте файл `wordpress.json` со следующим содержимым:
  ```json
  {
    "builders": [
      {
        "type": "amazon-ebs",
        "region": "us-west-2",
        "source_ami": "ami-0c55b159cbfafe1f0",
        "instance_type": "t2.micro",
        "ssh_username": "ubuntu",
        "ami_name": "wordpress-{{timestamp}}"
      }
    ],
    "provisioners": [
      {
        "type": "shell",
        "inline": [
          "sudo apt-get update",
          "sudo apt-get install -y apache2 php libapache2-mod-php mysql-server php-mysql",
          "sudo wget https://wordpress.org/latest.tar.gz",
          "sudo tar -xvf latest.tar.gz",
          "sudo mv wordpress /var/www/html/",
          "sudo chown -R www-www-data /var/www/html/wordpress",
          "sudo chmod -R 755 /var/www/html/wordpress",
          "sudo mv /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php",
          "sudo systemctl restart apache2"
        ]
      }
    ]
  }
  ```
- Замените `region`, `source_ami`, `instance_type` и `ssh_username` на соответствующие значения для вашей учетной записи AWS и предпочтительного региона.

3. Сборка образа виртуальной машины с использованием `Packer`.
- В терминале, находясь в директории проекта, выполните команду:
  ```
  packer build wordpress.json
  ```
- Дождитесь завершения процесса сборки образа виртуальной машины.

4. Проверка работоспособности созданного образа виртуальной машины.
- В консоли управления AWS перейдите в сервис EC2.
- Найдите созданный образ виртуальной машины (AMI) с именем `wordpress-<timestamp>`.
- Запустите новый экземпляр EC2, используя созданный образ виртуальной машины.
- После запуска экземпляра, получите его общедоступный IP-адрес.
- Откройте веб-браузер и перейдите по адресу `http://<public-ip>/wordpress`. Вы должны увидеть страницу установки `WordPress`.

### Индивидуальные задания.

**Вариант 1.** Создайте образ виртуальной машины с установленным и настроенным веб-сервером `Apache`.

**Вариант 2.** Создайте образ виртуальной машины с установленным и настроенным веб-сервером `Nginx`.

**Вариант 3.** Создайте образ виртуальной машины с установленным и настроенным сервером базы данных `MySQL`.

**Вариант 4.** Создайте образ виртуальной машины с установленным и настроенным сервером базы данных `PostgreSQL`.

**Вариант 5.** Создайте образ виртуальной машины с установленным и настроенным интерпретатором `PHP`.

**Вариант 6.** Создайте образ виртуальной машины с установленным и настроенным интерпретатором `Python`.

**Вариант 7.** Создайте образ виртуальной машины с установленным и настроенным интерпретатором `Ruby`.

**Вариант 8.** Создайте образ виртуальной машины с установленным и настроенным сервером приложений `Tomcat`.

**Вариант 9.** Создайте образ виртуальной машины с установленным и настроенным сервером приложений `JBoss`.

**Вариант 10.** Создайте образ виртуальной машины с установленным и настроенным сервером приложений `GlassFish`.

**Вариант 11.** Создайте образ виртуальной машины с установленным и настроенным сервером кеширования `Memcached`.

**Вариант 12.** Создайте образ виртуальной машины с установленным и настроенным сервером кеширования `Redis`.

**Вариант 13.** Создайте образ виртуальной машины с установленным и настроенным сервером очередей `RabbitMQ`.

**Вариант 14.** Создайте образ виртуальной машины с установленным и настроенным сервером очередей `Apache Kafka`.

**Вариант 15.** Создайте образ виртуальной машины с установленным и настроенным сервером мониторинга `Nagios`.

**Вариант 16.** Создайте образ виртуальной машины с установленным и настроенным сервером мониторинга `Zabbix`.

**Вариант 17.** Создайте образ виртуальной машины с установленным и настроенным сервером логирования `ELK stack` (Elasticsearch, Logstash, Kibana).

**Вариант 18.** Создайте образ виртуальной машины с установленным и настроенным сервером непрерывной интеграции `Jenkins`.

**Вариант 19.** Создайте образ виртуальной машины с установленным и настроенным сервером непрерывной интеграции `GitLab CI`.

**Вариант 20.** Создайте образ виртуальной машины с установленным и настроенным сервером управления конфигурацией `Puppet`.

**Вариант 21.** Создайте образ виртуальной машины с установленным и настроенным сервером управления конфигурацией `Chef`.

**Вариант 22.** Создайте образ виртуальной машины с установленным и настроенным сервером управления конфигурацией `Ansible`.

**Вариант 23.** Создайте образ виртуальной машины с установленным и настроенным сервером управления версиями `Git`.

**Вариант 24.** Создайте образ виртуальной машины с установленным и настроенным сервером управления версиями `Subversion`.

**Вариант 25.** Создайте образ виртуальной машины с установленным и настроенным стеком `LAMP` (Linux, Apache, MySQL, PHP).

### Форма отчета.
1. Титульный лист.
2. Цель работы.
3. Ход выполнения работы (с указанием используемых команд и их результатов).
4. Листинг созданного файла шаблона `Packer`.
5. Выводы по работе.
6. Ответы на контрольные вопросы.

### Контрольные вопросы.
1. Что такое неизменяемая инфраструктура и каковы ее преимущества?
2. Что такое `Packer` и для чего он используется?
3. Какие основные компоненты включает в себя шаблон `Packer`?
4. Как создать образ виртуальной машины с использованием `Packer`?
5. Каковы преимущества использования `Packer` для создания образов виртуальных машин?


